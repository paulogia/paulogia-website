---
interface Props {
  heading?: string;
  description?: string;
}

const {
  heading = 'Stay Updated',
  description = 'Get notified about new videos, articles, and content.'
} = Astro.props;
---

<section class="newsletter" aria-labelledby="newsletter-heading">
  <h2 id="newsletter-heading" class="newsletter-heading">{heading}</h2>
  <p class="newsletter-description">{description}</p>

  <form class="newsletter-form" id="newsletter-form" novalidate>
    <div class="form-group">
      <label for="email" class="visually-hidden">Email address</label>
      <input
        type="email"
        id="email"
        name="email"
        placeholder="Enter your email"
        required
        autocomplete="email"
        aria-describedby="form-privacy form-status"
      />
      <button type="submit" class="submit-button">
        <span class="button-text">Subscribe</span>
        <span class="button-loading" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32">
              <animate attributeName="stroke-dashoffset" values="32;0" dur="1s" repeatCount="indefinite"/>
            </circle>
          </svg>
        </span>
      </button>
    </div>

    <p id="form-privacy" class="privacy-note">No spam. Unsubscribe anytime.</p>

    <div id="form-status" class="form-status" role="status" aria-live="polite"></div>
  </form>
</section>

<style>
  .newsletter {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--spacing-xl) var(--spacing-md);
    text-align: center;
  }

  .newsletter-heading {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
    color: var(--color-text);
  }

  .newsletter-description {
    color: var(--color-text-muted);
    margin-bottom: var(--spacing-lg);
  }

  .form-group {
    display: flex;
    gap: var(--spacing-xs);
    max-width: 400px;
    margin: 0 auto;
  }

  input[type="email"] {
    flex: 1;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    color: var(--color-text);
    background-color: var(--color-bg-elevated);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--border-radius);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  }

  input[type="email"]::placeholder {
    color: var(--color-text-muted);
  }

  input[type="email"]:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-dim);
  }

  input[type="email"]:invalid:not(:placeholder-shown) {
    border-color: #ef4444;
  }

  .submit-button {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-bg);
    background-color: var(--color-accent);
    border-radius: var(--border-radius);
    transition: background-color var(--transition-fast), transform var(--transition-fast);
    min-width: 120px;
  }

  .submit-button:hover {
    background-color: #0ad477;
  }

  .submit-button:focus-visible {
    outline: 2px solid var(--color-text);
    outline-offset: 2px;
  }

  .submit-button:active {
    transform: scale(0.98);
  }

  .submit-button .button-loading {
    display: none;
  }

  .submit-button.loading .button-text {
    display: none;
  }

  .submit-button.loading .button-loading {
    display: block;
  }

  .submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .privacy-note {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-top: var(--spacing-sm);
  }

  .form-status {
    margin-top: var(--spacing-sm);
    font-size: 0.875rem;
    min-height: 1.5rem;
  }

  .form-status.success {
    color: var(--color-accent);
  }

  .form-status.error {
    color: #ef4444;
  }

  @media (max-width: 480px) {
    .form-group {
      flex-direction: column;
    }

    .submit-button {
      width: 100%;
    }
  }
</style>

<!-- MailerLite Universal -->
<script is:inline>
  (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[])
  .push(arguments);},l=d.createElement(e),l.async=1,l.src=u,
  n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
  (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
  ml('account', '2045962');
</script>

<script>
  const MAILERLITE_GROUP_ID = '176899270126864119';

  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const submitButton = form.querySelector('.submit-button') as HTMLButtonElement;
  const statusDiv = document.getElementById('form-status') as HTMLDivElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();

    // Basic email validation
    if (!email || !isValidEmail(email)) {
      showStatus('Please enter a valid email address.', 'error');
      emailInput.focus();
      return;
    }

    // Show loading state
    submitButton.classList.add('loading');
    submitButton.disabled = true;
    statusDiv.textContent = '';
    statusDiv.className = 'form-status';

    try {
      // Submit to MailerLite via their universal script
      const ml = (window as any).ml;
      if (ml) {
        ml('subscribe', {
          email: email,
          groups: [MAILERLITE_GROUP_ID]
        });
      }

      // MailerLite doesn't provide a callback, so we show success after a brief delay
      await new Promise(resolve => setTimeout(resolve, 500));

      showStatus('Thanks for subscribing! Check your inbox to confirm.', 'success');
      form.reset();
    } catch (error) {
      showStatus('Something went wrong. Please try again.', 'error');
    } finally {
      submitButton.classList.remove('loading');
      submitButton.disabled = false;
    }
  });

  function isValidEmail(email: string): boolean {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function showStatus(message: string, type: 'success' | 'error') {
    statusDiv.textContent = message;
    statusDiv.className = `form-status ${type}`;
  }
</script>
